<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Just for noting</title><link href="https://blog.m157q.tw/" rel="alternate"></link><link href="https://blog.m157q.tw/feeds/tag.0day.atom.xml" rel="self"></link><id>https://blog.m157q.tw/</id><updated>2016-09-19T17:46:28+08:00</updated><entry><title>CVE-2016-2662</title><link href="https://blog.m157q.tw/posts/2016/09/19/cve-2016-2662/" rel="alternate"></link><published>2016-09-19T17:46:28+08:00</published><updated>2016-09-19T17:46:28+08:00</updated><author><name>m157q</name></author><id>tag:blog.m157q.tw,2016-09-19:posts/2016/09/19/cve-2016-2662/</id><summary type="html">&lt;h2&gt;Preface&lt;/h2&gt;
&lt;p&gt;接近第一時間的時候稍微追了一下漏洞的 PoC，&lt;br /&gt;
雖然離事件發生也隔了好幾天了，&lt;br /&gt;
還是整理成一篇文章紀錄一下，&lt;br /&gt;
畢竟應該是今年最大的漏洞了吧？  &lt;/p&gt;
&lt;hr /&gt;
&lt;h2&gt;Note&lt;/h2&gt;
&lt;p&gt;漏洞的詳細細節都在以下這個文件：&lt;br /&gt;
&lt;a href="http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html"&gt;http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html&lt;/a&gt;&lt;br /&gt;
以下稍微紀錄之前追的時候看到的東西  &lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img alt="summary for CVE 2016-2662" src="/files/cve-2016-2662/1.jpg" /&gt;  &lt;/p&gt;
&lt;p&gt;這邊可以看到 MySQL 全部的版本都中獎了，&lt;br /&gt;
然後連 MariaDB 跟 PerconaDB 也中獎。  &lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img alt="PoC of CVE 2016-2662" src="/files/cve-2016-2662/2.jpg" /&gt;  &lt;/p&gt;
&lt;p&gt;從 PoC 可以看到，&lt;br /&gt;
是透過 &lt;code&gt;mysqld_safe&lt;/code&gt; 這個 wrapper script 來作為攻擊點。  &lt;/p&gt;
&lt;p&gt;即便 &lt;code&gt;mysqld&lt;/code&gt; 不是以 &lt;code&gt;root&lt;/code&gt; 的權限執行，&lt;br /&gt;
&lt;code&gt;MySQL&lt;/code&gt; 預設仍會讓 &lt;code&gt;mysqld_safe&lt;/code&gt; 這個 wrapper script 以 &lt;code&gt;root&lt;/code&gt; 的權限執行。&lt;br /&gt;
然後 &lt;code&gt;mysqld_safe&lt;/code&gt; 裡頭有個 &lt;code&gt;set_malloc_lib&lt;/code&gt; 的 function 可以用來 preload shared library，&lt;br /&gt;
至於要 preload 什麼 shared library 可以透過執行 &lt;code&gt;mysqld&lt;/code&gt; 時加入 &lt;code&gt;--malloc-lib=$LIB&lt;/code&gt;&lt;br /&gt;
或是在 &lt;code&gt;my.cnf&lt;/code&gt; 的 &lt;code&gt;mysqld&lt;/code&gt; 或 &lt;code&gt;mysqld_safe&lt;/code&gt; 的 section 中指定路徑。  &lt;/p&gt;
&lt;p&gt;如果攻擊者將惡意的 shared library 上傳到目標伺服器，&lt;br /&gt;
然後再將 &lt;code&gt;my.cnf&lt;/code&gt; 中的 preload library 路徑改到該惡意的 shared library 的路徑，&lt;br /&gt;
則目標伺服器下次重新啟動 &lt;code&gt;mysql&lt;/code&gt; 的時候，&lt;br /&gt;
就會載入該惡意的 shared library，&lt;br /&gt;
讓攻擊者達到執行任意程式碼的攻擊，&lt;br /&gt;
而且是以 root 的身份執行，&lt;br /&gt;
因為是由 &lt;code&gt;mysqld_safe&lt;/code&gt; load 進來的。  &lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;img alt="Status of CVE 2016-2662" src="/files/cve-2016-2662/3.jpg" /&gt;  &lt;/p&gt;
&lt;p&gt;今年 7 月 29 日通報 Oracle、MariaDB、PerconaDB。&lt;br /&gt;
後兩者已於今年 8 月 30 日修補漏洞，新的版本中不會有此漏洞。（所以我說 Oracle 呢？）  &lt;/p&gt;
&lt;p&gt;目前仍然沒有官方補丁可用。&lt;br /&gt;
一旦有補丁釋出，使用者應該儘快更新。  &lt;/p&gt;
&lt;p&gt;暫時的解法是確認 &lt;code&gt;mysql&lt;/code&gt; 這個 user 沒有任何 MySQL 的設定檔的 owner 權限，&lt;br /&gt;
然後建立一個只有 &lt;code&gt;root&lt;/code&gt; 有 owner 權限的 &lt;code&gt;my.cnf&lt;/code&gt; 的備份檔，&lt;br /&gt;
這部份應該就是在 &lt;code&gt;my.cnf&lt;/code&gt; 真的被改掉的話，可以回復回來。  &lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;a href="https://thehackernews.com/2016/09/hack-mysql-database.html"&gt;似乎還有一個 0-day CVE-2016-2663 不過好像還沒公佈細節&lt;/a&gt;  &lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;覺得整個攻擊的手法挺有趣的，&lt;br /&gt;
概念不難理解，&lt;br /&gt;
但可行性因為必須先注入惡意的 shared library 還要把 &lt;code&gt;my.cnf&lt;/code&gt; 的 &lt;code&gt;lib&lt;/code&gt; 路徑改掉，&lt;br /&gt;
然後還要重新啟動才會生效而大大降低，&lt;br /&gt;
反而平常沒在更新就不需要重啟的 MySQL server 不會出事。&lt;br /&gt;
但可行性低不代表不會發生，&lt;br /&gt;
個人覺得可能會出現在 APT 那種針對性的攻擊吧。  &lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;丟在 gist 上備份一下 &lt;a href="https://gist.github.com/M157q/a3c14b99905f3d3704b2477fb47cd33a"&gt;https://gist.github.com/M157q/a3c14b99905f3d3704b2477fb47cd33a&lt;/a&gt;  &lt;/p&gt;
&lt;hr /&gt;
&lt;h2&gt;Related Links&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html"&gt;http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://blog.gslin.org/archives/2016/09/13/6832/mysql-%E5%85%A8%E7%B3%BB%E5%88%97%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E6%BC%8F%E6%B4%9E/"&gt;MySQL 全系列的安全性漏洞 | Gea-Suan Lin's BLOG&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.percona.com/blog/2016/09/12/percona-server-critical-update-cve-2016-6662/"&gt;Percona Server Critical Update CVE-2016-6662 - Percona Database Performance Blog&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://thehackernews.com/2016/09/hack-mysql-database.html"&gt;New MySQL Zero Days — Hacking Website Databases&lt;/a&gt;  &lt;/li&gt;
&lt;/ul&gt;</summary><category term="Security"></category><category term="MySQL"></category><category term="CVE"></category><category term="0day"></category><category term="Remote Code Execution"></category></entry></feed>