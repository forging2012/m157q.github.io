<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Just for noting</title><link href="https://blog.m157q.tw/" rel="alternate"></link><link href="https://blog.m157q.tw/feeds/tag.kernel.atom.xml" rel="self"></link><id>https://blog.m157q.tw/</id><updated>2016-09-21T03:50:25+08:00</updated><entry><title>Cat System Workshop #11 Dynamically Hacking the Kernel with Containers</title><link href="https://blog.m157q.tw/posts/2016/09/21/cat-system-workshop-11-dynamically-hacking-the-kernel-with-containers/" rel="alternate"></link><published>2016-09-21T03:50:25+08:00</published><updated>2016-09-21T03:50:25+08:00</updated><author><name>m157q</name></author><id>tag:blog.m157q.tw,2016-09-21:posts/2016/09/21/cat-system-workshop-11-dynamically-hacking-the-kernel-with-containers/</id><summary type="html">&lt;h2&gt;Info&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;活動網址：&lt;a href="http://www.accupass.com/go/cat0920"&gt;http://www.accupass.com/go/cat0920&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;Spaker: 高魁良  &lt;/li&gt;
&lt;li&gt;Slides:&lt;a href="http://www.slideshare.net/QueyLiangKao/talk-160920-cat-system-workshop-66199432"&gt;Talk 160920 @ Cat System Workshop&lt;/a&gt;  &lt;ul&gt;
&lt;li&gt;講者在 ContainerCon Japan 2016 的投影片： &lt;a href="http://events.linuxfoundation.org/sites/events/files/slides/talk_7.pdf"&gt;Dynamically Hacking the Kernel with Containers - ContainerCon Japan 2016 Tokyo - Quey-Liang Kao - National Tsing Hua University, Taiwan&lt;/a&gt;  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h1&gt;Note&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;稍微提到了一下 Live Kernel Patching  &lt;/li&gt;
&lt;li&gt;Kernel Detouring  &lt;ul&gt;
&lt;li&gt;有點類似 Rootkit 的感覺  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Intel 也有在開發 Container，叫作 Clear Container，最近公佈了 2.0 版。  &lt;ul&gt;
&lt;li&gt;&lt;a href="https://clearlinux.org/clear-containers"&gt;https://clearlinux.org/clear-containers&lt;/a&gt;  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;ul&gt;
&lt;li&gt;可以在 Linux 的機器上跑 FreeBSD 的 container，透過換掉 System call 的 table 來達成。  &lt;/li&gt;
&lt;li&gt;Specific Challengs (FreeBSD)  &lt;ul&gt;
&lt;li&gt;Corresponding system calls  &lt;ul&gt;
&lt;li&gt;Flag numbers are not portable  &lt;/li&gt;
&lt;li&gt;Different calling/exiting conventions  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Unique system calls  &lt;ul&gt;
&lt;li&gt;Re-implementation  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;General Challenges  &lt;ul&gt;
&lt;li&gt;Insufficient isolation  &lt;/li&gt;
&lt;li&gt;Limitation of development  &lt;ul&gt;
&lt;li&gt;live patching should only be a temporary solution.  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Other Binary Compatibility Work  &lt;ul&gt;
&lt;li&gt;Wine  &lt;ul&gt;
&lt;li&gt;Special loader for PEs/DLLs  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;FreeBSD, Windows 10  &lt;ul&gt;
&lt;li&gt;Kernel built-in compatibility layer for Linux binary.  &lt;ul&gt;
&lt;li&gt;FreeBSD i386  &lt;/li&gt;
&lt;li&gt;Windows 10: Ubuntu on Windows 10 也是用類似的方法  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;System call remapping/re-implementation  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h2&gt;How&lt;/h2&gt;
&lt;h3&gt;Step 0: Setup&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Environment (x86_64 maching)  &lt;ul&gt;
&lt;li&gt;Linux 4.6.2  &lt;/li&gt;
&lt;li&gt;FreeBSD 10.2  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Tools  &lt;ul&gt;
&lt;li&gt;kpatch: A tool for kernel livepatch  &lt;/li&gt;
&lt;li&gt;docker  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Step 1: From LivePatching to Detouring&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;kernel/livepatch/core.c.orig:klp_ftrace_handler  

klp_arch_set_pc(regs, (unsigned long)func-&amp;gt;new_func);  
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;目前 LivePatching 最成熟的還是在 x86 的 machine 上  &lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;Ftrace in LivePatching&lt;/h4&gt;
&lt;p&gt;在 kernel 的 config 中要 enable &lt;code&gt;ftrace&lt;/code&gt; 和 &lt;code&gt;fentry&lt;/code&gt;&lt;br /&gt;
可以透過 ftrace 去抓到每個 function 被 call 的時間點。  &lt;/p&gt;
&lt;h4&gt;Ftrace in Detouring&lt;/h4&gt;
&lt;h3&gt;Step 2: Detour-able Entry Point&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly file is NOT detour-able  &lt;ul&gt;
&lt;li&gt;順便一提，也不支持 in-line function  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Step 3: Detoured Entry Point&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;maintain 一個 FreeBSD 的 system call table (不是一個 function pointer 的 table)  &lt;/li&gt;
&lt;li&gt;達到 remapping syscall 的效果  &lt;/li&gt;
&lt;li&gt;目前是用苦功寫死一個一個對應  &lt;ul&gt;
&lt;li&gt;&lt;code&gt;cat maps | wc -l&lt;/code&gt; 有 149 個可以互相對應的  &lt;/li&gt;
&lt;li&gt;&lt;code&gt;cat syscall.h | wc -l&lt;/code&gt; 468 FreeBSD 的 syscall  &lt;/li&gt;
&lt;li&gt;&lt;code&gt;cat unistd_64.h | wc -l&lt;/code&gt; 332 Linux 的 syscall  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h2&gt;The workflow&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Launch a normal container  &lt;/li&gt;
&lt;li&gt;Run a init script  &lt;ul&gt;
&lt;li&gt;which enables the specific detour modules  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;A FreeBSD environment in the container  &lt;/li&gt;
&lt;li&gt;On exit  &lt;ul&gt;
&lt;li&gt;disable detour modules  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;hr /&gt;
&lt;h2&gt;Demo&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://en.wikipedia.org/wiki/Truss_(Unix)"&gt;truss (Unix) - Wikipedia, the free encyclopedia&lt;/a&gt;  &lt;/li&gt;
&lt;li&gt;Linux 跟 FreeBSD 的 &lt;code&gt;execve&lt;/code&gt; 剛好是同個號碼  &lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h2&gt;總結&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;The kernel detouring demo attempts to indicate a possible movement of the development of OS containers  &lt;ul&gt;
&lt;li&gt;as a proof-of-concept  &lt;/li&gt;
&lt;li&gt;kpatch as a temporary solution  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Future direction  &lt;ul&gt;
&lt;li&gt;Make more fun  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h2&gt;一些討論&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;自己寫一個 ftrace handler 改掉 detour 的 destination 可能會是比較好的作法。  &lt;/li&gt;
&lt;li&gt;講者在日本的 ContainerCon 給 talk 的時候有人給了 &lt;code&gt;execution domain&lt;/code&gt; 這個關鍵字。  &lt;ul&gt;
&lt;li&gt;Linux 在 2015 前有個東西叫作，&lt;a href="https://linux.die.net/man/2/personality"&gt;execution domain&lt;/a&gt;  &lt;ul&gt;
&lt;li&gt;BSD 的部份是沒有實作的。(no effects.)  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;這邊只有針對 syscall 的 entry point 去改,沒有要 hook 到多深，也許會覺得用 ftrace 太 powerful，何不改寫 ptrace 就好。或是直接使用 user space Linux 等等。  &lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.freebsd.org/doc/en_US.ISO8859-1/articles/linux-emulation/article.html"&gt;Linux® emulation in FreeBSD&lt;/a&gt;  &lt;blockquote&gt;
&lt;p&gt;想當初修 SA 的時候 flash player 在 FreeBSD 上編不起來好像就是用這招。  &lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h2&gt;幕後花絮&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;How to implement the &lt;code&gt;is_freebsd_container()&lt;/code&gt; function?  &lt;/li&gt;
&lt;li&gt;How was the ContainerCon Japan?  &lt;ul&gt;
&lt;li&gt;跟當地的社群互動滿有趣的  &lt;/li&gt;
&lt;li&gt;會議室比較高級、沒有 host、會幫你準備好投影機、白板。  &lt;/li&gt;
&lt;li&gt;講者：「我覺得可以考慮不要去。」 （眾：XDDDD）  &lt;ul&gt;
&lt;li&gt;「裏面有一半以上的講者是日本人，腔調不是問題，主要是單位時間內的資訊密度，很多講者為了把發音腔調正確會講得很慢。」  &lt;ul&gt;
&lt;li&gt;jserv: 「日本砸了很多錢在這上面，所以有一半以上的講者是日本人很正常的。」  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;「然後很多講者的問答時間都沒有人理。」  &lt;ul&gt;
&lt;li&gt;jserv: 「他們可能都已經在公司聽過同事講過完整的日文版了，只是來這邊聽比較沒那麼完整的英文版。」  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;「日本人用 Twitter 用很兇，有位老老的日本人在我演講完後問了很多的問題，然後問我有沒有用 Twitter，把我加到了一個討論 Container 的 Group 裏面。我才發現他在聽我演講的時候發了很多推，然後這些推底下都有他的推友在討論，有提到 Execution domain，也有說我的某頁簡報毫無意義的評論，於是我用我沒那麼好的日文跟他們來來回回得回覆，但不知道是不是我的日文用字拿捏的不好，隔天我發現他們全都取消追蹤我而且還把我踢出那個討論 container 的 group。」  &lt;ul&gt;
&lt;li&gt;xatier：「一定是沒跟他們喝酒的關係，日本人都是喝了酒馬上就熟了。」  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;「有位中國人看到我投影片的第一頁，就跑過來問我說：『你清華的啊？』『嗯，但我是臺灣的清華』然後他就當著我的面拿著他的東西走出去了。」  &lt;ul&gt;
&lt;li&gt;jserv：「你下次遇到這種就要直接跟他講英文，他跟你用中文你還是一直跟他說英文，不然像你這樣整個就弱掉了。」  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;覺得 jserv 後來跟講者講的一些東西也頗值得紀錄一下的：  &lt;ul&gt;
&lt;li&gt;「你去了 Linux Foundation 辦的 Conference 一趟應該就知道當講者的不是超級大的公司就是超級小的公司，像你這種只有學生身份的是非常少的。」「對啊，有位和我討論的德國人也有聊到，他直接就說他覺得是主辦單位找不到足夠的講者才找我。」「也好啦，至少是一次出去看看的經驗。」  &lt;/li&gt;
&lt;li&gt;「看到滿多人說我的演講跟他們預期的有落差。」「你這次去就知道他們都是業界的工程師，你的摘要就輸人家了，人家 Twitter 是講幾萬台伺服器的佈署、Facebook 是講二十億使用者的資料分析」「對啊，我講的東西根本沒有 scale。」「他們很多人是公司出錢讓他們來的，最便宜的門票一張也要五百多鎂，你講的東西太空洞讓他們沒辦法寫報告的話，交不出報告就會被主管罵。」  &lt;/li&gt;
&lt;li&gt;「你的題目是還不錯，開始演講時的高度是在這，但你講完以後高度只有上升一點點。」「程式碼的部份放的太少算是我的失策。」「你的簡報太早做完了，你應該在聽完第一場 keynote 的時候就會知道日本這邊大概喜歡怎麼樣的簡報，你就要在這個時候開始修改你的簡報。」「哦對，日本人好像超級喜歡格言，看到有一個 keynote 講者，一開始的十張投影片全部都是格言然後搭配文青風格的照片背景，滿受大家歡迎的。」  &lt;/li&gt;
&lt;li&gt;「你這個演講就是缺乏應用的部份，因為參加的都是真的在業界的工程師，所以他們會希望看到你講的東西解決了什麼問題，如果沒有這部份的話，只會讓他們覺得『靠，又是一個窮學生來這邊講論文。』我覺得你這個可以考慮弄個 IDS，因為 syscall 都是抽換掉的，所以不用怕，甚至可以重現一堆 CVE，來分析攻擊者的行為。」「對耶，滿多人後來反應演講跟預期有落差的時候，我就有聽到我後面的人在用日語說『原來是學生而且還是做 High Performance Computing 又不是研究 Container 的，難怪』之類的。」「下次你就要問問看有沒有公司願意讓你掛名，你就可以放在投影片上，這樣就比較不會被這些業界的工程師看不起，你的英文表達能力基本上已經超過他們一半在場的日本工程師啦。」  &lt;/li&gt;
&lt;li&gt;「演講就是要安排暗樁啊，不然聽眾很容易聽到睡著的。像你的演講是第三天的上午，前面兩天就要儘量去認識人，然後跟他們稍微賣點關子，請他們來聽你的演講。」  &lt;/li&gt;
&lt;li&gt;「Linux Foundation 對於演講順序的安排是有根據的，不只是演講的內容，也會去查一下這個講者的影響力還有做了哪些事情，評價愈高的當然就是 keynote spearker。」  &lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary><category term="Kernel"></category><category term="Containers"></category><category term="Cat System Workshop"></category><category term="Meetup"></category></entry></feed>