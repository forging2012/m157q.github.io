<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>  CVE-2016-2662
 | Just for noting</title>

    <meta name="author" content="m157q"/>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.min.css"/>
    <link rel="stylesheet" href="https://blog.m157q.tw/theme/css/jquery.mglass.css"/>
    <link rel="stylesheet" href="https://blog.m157q.tw/theme/css/pygment-solarized-dark.css"/>
    <link rel="stylesheet" href="https://blog.m157q.tw/theme/css/style.css"/>

    <!-- Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/>
    <link href='https://fonts.googleapis.com/css?family=Istok+Web' rel='stylesheet' type='text/css'/>
    <link href='https://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'/>


    <link rel="icon" href="https://blog.m157q.tw/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="https://blog.m157q.tw/favicon.ico" type="image/x-icon">

    <!-- Feeds -->
      <link href="https://blog.m157q.tw/feeds/all.feed.atom.xml" type="application/atom+xml" rel="alternate" title="Just for noting - All posts - Atom Feed"/>
      <link href="https://blog.m157q.tw/feeds/all.feed.rss.xml" type="application/rss+xml" rel="alternate" title="Just for noting - All posts - RSS Feed"/>
      <link href="https://blog.m157q.tw/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Just for noting - Latest posts - Atom Feed"/>
      <link href="https://blog.m157q.tw/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Just for noting - Latest posts - RSS Feed"/>
      <link href="https://blog.m157q.tw/feeds/category.note.atom.xml" type="application/atom+xml" rel="alternate" title="Just for noting - Category: Note - Atom Feed"/>
      <link href="https://blog.m157q.tw/feeds/category.note.rss.xml" type="application/rss+xml" rel="alternate" title="Just for noting - Category: Note - RSS Feed"/>

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-45367183-2', 'auto');
    ga('send', 'pageview');
    </script>



  </head>

  <body>

    <div class="container">

      <div class="page-header">
        <h1><a href="https://blog.m157q.tw">Just for noting</a> <small></small></h1>
      </div>

      <nav class="navbar navbar-default">

        <!-- Hamburger menu for mobile -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#plumage-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://blog.m157q.tw" title="">Just for noting</a>
        </div>

        <!-- Menus and search forms -->
        <div class="collapse navbar-collapse" id="plumage-navbar-collapse-1">

          <ul class="nav navbar-nav">
<li >
                <a href="/categories">Categories</a>
              </li>
<li >
                <a href="/archives">Archives</a>
              </li>
<li >
                <a href="/tags">Tags</a>
              </li>
<li >
                  <a href="https://blog.m157q.tw/pages/cv/">CV</a>
                </li>
          </ul>


            <form class="navbar-form navbar-right" role="search" action="https://blog.m157q.tw/search.html" onsubmit="return validateForm(this.elements['q'].value);">
              <div class="form-group">
                <div class="input-group">
                  <input type="text" name="q" id="tipue_search_input" class="form-control search-query" placeholder="Search" required />
                  <span class="input-group-btn">
                    <button class="btn btn-default" type="submit"><i class="fa
                        fa-search fa-fw"></i></button>
                  </span>
                </div>
              </div>
            </form>

        </div>

      </nav>

    </div>


    <div class="container main">


      <div class="row">
        <div class=" col-md-9  ">
  <h1>
    <a href="https://blog.m157q.tw/posts/2016/09/19/cve-2016-2662/" rel="bookmark" title="Permalink to CVE-2016-2662">CVE-2016-2662</a>
  </h1>
        </div>
      </div>

      <div class="row">


        <div class=" col-md-9 " id="content" role="main">
  

  <blockquote>
    <p>MySQL Exploit Remote Root Code Execution Privesc CVE 2016 6662</p>
  </blockquote>
  <div>
    <h2>Preface</h2>
<p>接近第一時間的時候稍微追了一下漏洞的 PoC，<br />
雖然離事件發生也隔了好幾天了，<br />
還是整理成一篇文章紀錄一下，<br />
畢竟應該是今年最大的漏洞了吧？  </p>
<hr />
<h2>Note</h2>
<p>漏洞的詳細細節都在以下這個文件：<br />
<a href="http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html">http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html</a><br />
以下稍微紀錄之前追的時候看到的東西  </p>
<hr />
<p><img alt="summary for CVE 2016-2662" src="/files/cve-2016-2662/1.jpg" />  </p>
<p>這邊可以看到 MySQL 全部的版本都中獎了，<br />
然後連 MariaDB 跟 PerconaDB 也中獎。  </p>
<hr />
<p><img alt="PoC of CVE 2016-2662" src="/files/cve-2016-2662/2.jpg" />  </p>
<p>從 PoC 可以看到，<br />
是透過 <code>mysqld_safe</code> 這個 wrapper script 來作為攻擊點。  </p>
<p>即便 <code>mysqld</code> 不是以 <code>root</code> 的權限執行，<br />
<code>MySQL</code> 預設仍會讓 <code>mysqld_safe</code> 這個 wrapper script 以 <code>root</code> 的權限執行。<br />
然後 <code>mysqld_safe</code> 裡頭有個 <code>set_malloc_lib</code> 的 function 可以用來 preload shared library，<br />
至於要 preload 什麼 shared library 可以透過執行 <code>mysqld</code> 時加入 <code>--malloc-lib=$LIB</code><br />
或是在 <code>my.cnf</code> 的 <code>mysqld</code> 或 <code>mysqld_safe</code> 的 section 中指定路徑。  </p>
<p>如果攻擊者將惡意的 shared library 上傳到目標伺服器，<br />
然後再將 <code>my.cnf</code> 中的 preload library 路徑改到該惡意的 shared library 的路徑，<br />
則目標伺服器下次重新啟動 <code>mysql</code> 的時候，<br />
就會載入該惡意的 shared library，<br />
讓攻擊者達到執行任意程式碼的攻擊，<br />
而且是以 root 的身份執行，<br />
因為是由 <code>mysqld_safe</code> load 進來的。  </p>
<hr />
<p><img alt="Status of CVE 2016-2662" src="/files/cve-2016-2662/3.jpg" />  </p>
<p>今年 7 月 29 日通報 Oracle、MariaDB、PerconaDB。<br />
後兩者已於今年 8 月 30 日修補漏洞，新的版本中不會有此漏洞。（所以我說 Oracle 呢？）  </p>
<p>目前仍然沒有官方補丁可用。<br />
一旦有補丁釋出，使用者應該儘快更新。  </p>
<p>暫時的解法是確認 <code>mysql</code> 這個 user 沒有任何 MySQL 的設定檔的 owner 權限，<br />
然後建立一個只有 <code>root</code> 有 owner 權限的 <code>my.cnf</code> 的備份檔，<br />
這部份應該就是在 <code>my.cnf</code> 真的被改掉的話，可以回復回來。  </p>
<hr />
<p><a href="https://thehackernews.com/2016/09/hack-mysql-database.html">似乎還有一個 0-day CVE-2016-2663 不過好像還沒公佈細節</a>  </p>
<hr />
<p>覺得整個攻擊的手法挺有趣的，<br />
概念不難理解，<br />
但可行性因為必須先注入惡意的 shared library 還要把 <code>my.cnf</code> 的 <code>lib</code> 路徑改掉，<br />
然後還要重新啟動才會生效而大大降低，<br />
反而平常沒在更新就不需要重啟的 MySQL server 不會出事。<br />
但可行性低不代表不會發生，<br />
個人覺得可能會出現在 APT 那種針對性的攻擊吧。  </p>
<hr />
<p>丟在 gist 上備份一下 <a href="https://gist.github.com/M157q/a3c14b99905f3d3704b2477fb47cd33a">https://gist.github.com/M157q/a3c14b99905f3d3704b2477fb47cd33a</a>  </p>
<hr />
<h2>Related Links</h2>
<ul>
<li><a href="http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html">http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html</a>  </li>
<li><a href="https://blog.gslin.org/archives/2016/09/13/6832/mysql-%E5%85%A8%E7%B3%BB%E5%88%97%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E6%BC%8F%E6%B4%9E/">MySQL 全系列的安全性漏洞 | Gea-Suan Lin's BLOG</a>  </li>
<li><a href="https://www.percona.com/blog/2016/09/12/percona-server-critical-update-cve-2016-6662/">Percona Server Critical Update CVE-2016-6662 - Percona Database Performance Blog</a>  </li>
<li><a href="https://thehackernews.com/2016/09/hack-mysql-database.html">New MySQL Zero Days — Hacking Website Databases</a>  </li>
</ul>
  </div>

    <hr>
    <section>
        <p id="post-share-links">
            <h3>Share</h3>
            <a href="https://twitter.com/intent/tweet?text=CVE-2016-2662%0Ahttps%3A//blog.m157q.tw/posts/2016/09/19/cve-2016-2662/%0Avia%20%40M157q%0A" target="_blank" title="Share on Twitter"><i class="fa fa-twitter-square fa-3x"></i></a>
            <a href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=https%3A//blog.m157q.tw/posts/2016/09/19/cve-2016-2662/" target="_blank" title="Share on Facebook"><i class="fa fa-facebook-square fa-3x"></i></a>
            <a href="https://plus.google.com/share?url=https%3A//blog.m157q.tw/posts/2016/09/19/cve-2016-2662/" target="_blank" title="Share on Google Plus"><i class="fa fa-google-plus-square fa-3x"></i></a>
            <a href="mailto:?subject=CVE-2016-2662&amp;body=https%3A//blog.m157q.tw/posts/2016/09/19/cve-2016-2662/" target="_blank" title="Share via Email"><i class="fa fa-envelope-o fa-3x"></i></a>
        </p>
    </section>

<hr>
<section id="donation">
    <h3>Donation</h3>
    <p id="donation-chinese">
      如果覺得這篇文章對你有幫助，
      除了留言讓我知道外，
      或許也可以考慮請我喝杯咖啡，
      不論金額多寡我都會非常感激且能鼓勵我繼續寫出對你有幫助的文章。
    </p>
    <p id="donation-english">
      If this blog post happens to be helpful to you, besides of leaving a reply, you may consider buy me a cup of coffee to support me. It would help me write more articles helpful to you in the future and I would really appreciate it.
    </p>
    <ul id="donation-address">
			<li><a href="https://payment.opay.tw/Broadcaster/Donate/4E163AAE10E448A30DB244CF85527271">歐付寶</a></li>

			<li><a href="https://www.paypal.me/m157q">PayPal</a></li>

			<li>BTC: <a href="https://blockchain.info/address/1HWMzBGTQ8VUJGXgvSDzAFacfeY2sLiZda">1HWMzBGTQ8VUJGXgvSDzAFacfeY2sLiZda</a></li>

			<li>ETH: <a href="https://etherscan.io/address/0x0380433c5cdda13c8cd6cff5ddbcc1d7701bcb83">0x0380433c5cdda13c8cd6cff5ddbcc1d7701bcb83</a></li>

			<li>LTC: <a href="https://chainz.cryptoid.info/ltc/address.dws?LUFkjq32kEAiYqnMG25isqGNdgkehj9rJT.htm">LUFkjq32kEAiYqnMG25isqGNdgkehj9rJT</a></li>
    </ul>
</section>

    <hr>
    <h3>Related Posts</h3>
    <!-- TODO: Use fancier related layout, as in http://kevin.deldycke.com/2012/04/beautify-contextual-related-posts-wordpress-plugin/ -->
    <ul>
        <li><a href="https://blog.m157q.tw/posts/2016/11/07/y2016w44/">Y2016W44</a></li>
        <li><a href="https://blog.m157q.tw/posts/2017/08/07/y2017w31/">Y2017W31</a></li>
        <li><a href="https://blog.m157q.tw/posts/2017/09/04/y2017w35/">Y2017W35</a></li>
        <li><a href="https://blog.m157q.tw/posts/2013/11/22/itc-week9-hash/">ITC week9 - Hash</a></li>
        <li><a href="https://blog.m157q.tw/posts/2015/02/18/malware-deep-within-hard-drive-firmware/">Malware Deep Within Hard Drive Firmware</a></li>
      </ul>

    <div class="comments">
      <div id="disqus_thread"></div>
	  <script type="text/javascript">
        var disqus_shortname = 'm157q-logdown';
        var disqus_identifier = "posts/2016/09/19/cve-2016-2662/";
        var disqus_title = "CVE-2016-2662";
        var disqus_url = "https://blog.m157q.tw/posts/2016/09/19/cve-2016-2662/";

        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
        };
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript>
    </div>

        </div>

          <div class="col-md-3">
  <div class="well">

    <p><abbr title="2016-09-19T17:46:28+08:00"><i class="fa fa-calendar"></i> Mon 19 September 2016</abbr></p>


      <p><address>
        <i class="fa fa-user"></i> By
          <a href="https://blog.m157q.tw/author/m157q.html" rel="author">m157q</a>
      </address></p>

    <hr/>

      <p>
              <p>
              <a href="https://blog.m157q.tw/category/note/" rel="tag"
                  data-toggle="tooltip"
                  class="label label-info"
                  title="119 articles in this category">Note</a>
              </p>
            <a href="/tag/security/" data-toggle="tooltip"
      class="label label-default"
      title="44 articles with this tag">Security</a>
  <br>
            <a href="/tag/mysql/" data-toggle="tooltip"
      class="label label-default"
      title="8 articles with this tag">mysql</a>
  <br>
            <a href="/tag/remote-code-execution/" data-toggle="tooltip"
      class="label label-default"
      title="1 article with this tag">Remote Code Execution</a>
  <br>
            <a href="/tag/0day/" data-toggle="tooltip"
      class="label label-default"
      title="1 article with this tag">0day</a>
  <br>
            <a href="/tag/cve/" data-toggle="tooltip"
      class="label label-default"
      title="1 article with this tag">CVE</a>
  <br>
      </p>
      <hr/>


      <nav>
        <ul class="pager">
          <li class="previous ">
            <a  href="https://blog.m157q.tw/posts/2016/09/18/y2016w37/" title="Y2016W37"  rel="prev">
              <span aria-hidden="true">←</span> Older
            </a>
          </li>
          <li class="next ">
            <a  href="https://blog.m157q.tw/posts/2016/09/21/cat-system-workshop-11-dynamically-hacking-the-kernel-with-containers/" title="Cat System Workshop #11 Dynamically Hacking the Kernel with Containers"  rel="next">
              Newer <span aria-hidden="true">→</span>
            </a>
          </li>
        </ul>
      </nav>

  </div>
            
          </div>

      </div>

    </div>

    <!-- TODO: make footer sticky -->
    <footer class="container-fluid">
      <div class="container">
        <div class="row">

            <div class="col-md-2">
                <h5>Social</h5>
                <ul class="list-unstyled">
                  <li>  <a href="https://github.com/M157q">
      <i class="fa fa-github"></i>
    GitHub
  </a></li>
                  <li>  <a href="https://www.twitter.com/M157q">
      <img src="https://icons.better-idea.org/icon?url=www.twitter.com&size=16" width="16" height="16" class="icon" alt="www.twitter.com icon"/>
    Twitter
  </a></li>
                </ul>
            </div>
            <div class="col-md-2">
                <h5>Links</h5>
                <ul class="list-unstyled">
                  <li>  <a href="http://getpelican.com/">
      <img src="https://icons.better-idea.org/icon?url=getpelican.com&size=16" width="16" height="16" class="icon" alt="getpelican.com icon"/>
    Pelican
  </a></li>
                  <li>  <a href="http://python.org/">
      <img src="https://icons.better-idea.org/icon?url=python.org&size=16" width="16" height="16" class="icon" alt="python.org icon"/>
    Python.org
  </a></li>
                  <li>  <a href="http://jinja.pocoo.org/">
      <img src="https://icons.better-idea.org/icon?url=jinja.pocoo.org&size=16" width="16" height="16" class="icon" alt="jinja.pocoo.org icon"/>
    Jinja2
  </a></li>
                </ul>
            </div>

          <div class="col-md-2">
            <h5>Browse content by</h5>
            <ul class="list-unstyled">
                <li><a href="https://blog.m157q.tw/categories/index.html"><i class="fa fa-tags"></i> Categories</a></li>
                <li><a href="https://blog.m157q.tw/archives/index.html"><i class="fa fa-calendar"></i> Dates</a></li>
                <li><a href="https://blog.m157q.tw/tags/index.html"><i class="fa fa-tag"></i> Tags</a></li>
            </ul>
          </div>

          <div class="col-md-2 text-muted">
            <h5>Copyright notice</h5>
            <p>© Copyright 2013-2018 m157q.</p>
          </div>

          <div class="col-md-2 text-muted">
            <h5>Disclaimer</h5>
              <p>All opinions expressed in this site are my own personal opinions and are not endorsed by, nor do they represent the opinions of my previous, current and future employers or any of its affiliates, partners or customers.</p>
          </div>

          <div class="col-md-2">
              <h5>Feeds</h5>
              <ul class="list-unstyled">
                  <li><small><a href="https://blog.m157q.tw/feeds/all.feed.atom.xml"><i class="fa fa-rss"></i> All posts (Atom)</a></small></li>
                  <li><small><a href="https://blog.m157q.tw/feeds/all.feed.rss.xml"><i class="fa fa-rss"></i> All posts (RSS)</a></small></li>
                  <li><small><a href="https://blog.m157q.tw/feeds/atom.xml"><i class="fa fa-rss"></i> Latest posts (Atom)</a></small></li>
                  <li><small><a href="https://blog.m157q.tw/feeds/rss.xml"><i class="fa fa-rss"></i> Latest posts (RSS)</a></small></li>
                  <li><small><a href="https://blog.m157q.tw/feeds/category.note.atom.xml"><i class="fa fa-rss"></i> Category: Note (Atom)</a></small></li>
                  <li><small><a href="https://blog.m157q.tw/feeds/category.note.rss.xml"><i class="fa fa-rss"></i> Category: Note (RSS)</a></small></li>
              </ul>
          </div>

        </div>
      </div>

      <h5 class="text-right"><a href="#"><i class="fa fa-arrow-up"></i> Back to top</a></h5>

      <div class="container">
        <div class="row col-md-12 text-muted text-center">
          Site generated by <a href="https://getpelican.com"> Pelican</a>.<br/>
          <a href="https://github.com/kdeldycke/plumage"> Plumage</a> theme by <a href="https://kevin.deldycke.com">Kevin Deldycke</a>.
        </div>
      </div>

    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fitvids/1.1.0/jquery.fitvids.min.js"></script>
    <script src="https://blog.m157q.tw/theme/js/jquery.mglass.js"></script>
    <script src="https://blog.m157q.tw/theme/js/application.js"></script>

  </body>
</html>